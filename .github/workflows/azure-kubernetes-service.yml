name: Build and deploy an app to AKS

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

env:
  GH_CONTAINER_REGISTRY: "cashflow.azurecr.io"
  CONTAINER_NAME: "cashflow-api"
  RESOURCE_GROUP: "cashflow"
  CLUSTER_NAME: "cashflow-cluster"
  DEPLOYMENT_MANIFEST_PATH: './k8s/cashflow-api.yaml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    # Checks out the repository this file is in
    - uses: actions/checkout@v3
      
    - name: Get K8s context
      uses: Azure/aks-set-context@v2.0
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
        resource-group: ${{ env.RESOURCE_GROUP }}
        cluster-name: ${{ env.CLUSTER_NAME }}

    # Deploys application based on given manifest file
    - name: Deploys application
      run: | 
        kubectl apply -f {{ DEPLOYMENT_MANIFEST_PATH }}
